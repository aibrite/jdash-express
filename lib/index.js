"use strict";var moment=require("moment"),JDashApi=function(){function t(t){this.options=t,this.provider=t.provider}return t.prototype.handleError=function(t){},t.prototype.deleteDashletRoute=function(t,e,r){var o=t.params.id;this.options.principal(t);this.provider.deleteDashlet(o).then(function(){return e.sendStatus(200)}).catch(function(t){return r(t)})},t.prototype.saveDashletRoute=function(t,e,r){this.options.principal(t);var o=t.params.id,i=t.body;this.provider.updateDashlet(o,i).then(function(t){return e.sendStatus(200)}).catch(function(t){return r(t)})},t.prototype.createDashletRoute=function(t,e,r){var o=t.body,i=(this.options.principal(t),{title:o.title,configuration:o.configuration,description:o.description,createdAt:moment().utc().toDate(),dashboardId:o.dashboardId,moduleId:o.moduleId});this.provider.createDashlet(i).then(function(t){return e.send(t)}).catch(function(t){return r(t)})},t.prototype.saveDashboardRoute=function(t,e,r){var o,i=this,a=this.options.principal(t),n=t.params.id,s=t.body;return s&&s.layout&&s.layout.dashlets&&(o=this.provider.getDashboard(a.appid,n).then(function(t){var e=t.dashlets.map(function(t){return t.id}),r=Object.keys(s.layout.dashlets),o=e.filter(function(t){return-1===r.indexOf(t)});return i.provider.deleteDashlet(o)})),o?o.then(function(){i.provider.updateDashboard(a.appid,n,s).then(function(t){return e.sendStatus(200)}).catch(function(t){return r(t)})}):this.provider.updateDashboard(a.appid,n,s).then(function(t){return e.sendStatus(200)}).catch(function(t){return r(t)})},t.prototype.getMyDashboardRoute=function(t,e,r){var o=this.options.principal(t);this.provider.searchDashboards({appid:o.appid,user:o.user}).then(function(t){return e.send(t)})},t.prototype.deleteDashboardRoute=function(t,e,r){var o=t.params.id,i=this.options.principal(t);this.provider.deleteDashboard(i.appid,o).then(function(){return e.sendStatus(200)}).catch(function(t){return r(t)})},t.prototype.searchDashboardsRoute=function(t,e,r){var o=this.options.principal(t),i=t.body.search,a=t.body.query;this.provider.searchDashboards({appid:o.appid,shareWith:i.shareWith,user:i.user},a).then(function(t){return e.send(t)})},t.prototype.createDashboardRoute=function(t,e,r){var o=this.options.principal(t),i=t.body,a={title:i.title,appid:o.appid,config:i.config,createdAt:moment().utc().toDate(),description:i.description,layout:i.layout,shareWith:i.shareWith,user:o.user,id:null};this.provider.createDashboard(a).then(function(t){return e.send(t)}).catch(function(t){return r(t)})},t.prototype.getDashboardRoute=function(t,e,r){var o=t.params.id,i=this.options.principal(t);this.provider.getDashboard(i.appid,o).then(function(t){return e.send(t)}).catch(function(t){return r(t)})},t.lclControl=function(t,e,r){if(t.host.indexOf(Buffer.from("bG9jYWxob3N0","base64").toString())>-1||t.host.indexOf(Buffer.from("MTI3LjAuMC4x","base64").toString())>-1)r();else{var o=Buffer.from("SkRhc2ggVHJpYWwgQ2FuIE9ubHkgQmUgVXNlZCBXaXRoaW4gJ2xvY2FsaG9zdCAtIDEyNy4wLjAuMSAnIGRvbWFpbiBhZHJlc3Nlcw==","base64");e.status(500),e.write(o.toString()),e.end()}},t.prototype.use=function(e){return e.use(t.lclControl),e.get("/dashboard/my",this.getMyDashboardRoute.bind(this)),e.get("/dashboard/:id",this.getDashboardRoute.bind(this)),e.post("/dashboard/create",this.createDashboardRoute.bind(this)),e.post("/dashboard/search",this.searchDashboardsRoute.bind(this)),e.post("/dashboard/delete/:id",this.deleteDashboardRoute.bind(this)),e.post("/dashboard/save/:id",this.saveDashboardRoute.bind(this)),e.post("/dashlet/create",this.createDashletRoute.bind(this)),e.post("/dashlet/delete/:id",this.deleteDashletRoute.bind(this)),e.post("/dashlet/save/:id",this.saveDashletRoute.bind(this)),this},t}();exports.JDashApi=JDashApi,Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(t){return new JDashApi(t)};